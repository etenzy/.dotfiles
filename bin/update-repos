#!/usr/bin/env bash

source $HOME/.dotfiles/shell/logging.sh

set -eo pipefail

inputDir=${1:-$(pwd)}

ANYFAIL=false
log_task "Updating git repositories"

directories=$(find $inputDir -path $HOME/Library -prune -o -path $HOME/Pictures -prune -o -name "**.Trash" -prune -o -type d -name ".git" -print)

for directory in $directories; do
    if [[ "$directory" =~ .*".git" ]]; then
        repo=$(dirname $directory)
        cd $repo

        echo $repo >> $HOME/git-log

        mainBranch=$(git branch --list | grep -E "(main|master)" | awk '{print $2}')

        git switch $mainBranch &>> $HOME/git-log
        
        log_task "Updating $repo" \
            && git fetch origin &>> $HOME/git-log \
            && log_info "git fetch origin" \
            && git pull --all &>> $HOME/git-log \
            && log_info "git pull --all" \
            && log_task_success \
            || (log_task_fail && ANYFAIL=true)

        echo "" >> $HOME/git-log
    else
        log_error "$directory is not a git repository"
    fi
done

if [ "$ANYFAIL" = true ]; then
    log_task_fail

    log_info "Check $HOME/git-log for more information"
else
    log_task_success

    mv $HOME/git-log $HOME/.Trash/
fi